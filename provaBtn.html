<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtro Ristoranti Interattivo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f9;
        }

        /* --- Stili Filtri --- */
        .filtro-container {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            color: #333;
        }
        .filtro-opzioni {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* Nascondi gli input radio/checkbox nativi */
        .hidden-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none; /* Assicura che non siano cliccabili */
        }
        
        .option-btn {
            /* Stili del bottone che l'utente vede e clicca */
            padding: 10px 15px;
            border: 2px solid #ccc;
            background-color: #f8f8f8;
            cursor: pointer;
            border-radius: 20px; /* Pi√π arrotondato per un look moderno */
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            font-size: 14px;
        }

        .option-btn:hover {
            background-color: #eee;
            border-color: #aaa;
        }

        /* Stato selezionato: il radio/checkbox √® selezionato (checked) */
        /* Stile applicato al bottone (+ .option-btn) quando l'input invisibile √® :checked */
        .hidden-input:checked + .option-btn {
            border-color: #007bff; /* Blu accattivante */
            background-color: #e6f7ff;
            color: #007bff;
            font-weight: bold;
        }

        /* --- Stili Bottoni Azione --- */
        .bottoni {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 20px 0;
        }
        .bottoni-2 {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #cancellaFiltri {
            background-color: #f0f0f0;
            color: #333;
        }
        input[type="submit"] {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }

        /* --- Stili Risultati --- */
        #results {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .restaurant-card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .restaurant-card h4 {
            margin-top: 0;
            color: #007bff;
        }
        .fav-btn {
            background: none;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <form id="scelta">
        <div class="scelta">
            
            <div class="filtro-container">
                <h3> Scegli la citt√† in cui vuoi mangiare</h3>
                <div class="filtro-opzioni" id="citta-opzioni">
                    <input type="radio" name="citta" value="terni" id="citta-terni" class="hidden-input">
                    <button type="button" class="option-btn" data-for="citta-terni">Terni</button>
                    
                    <input type="radio" name="citta" value="spoleto" id="citta-spoleto" class="hidden-input">
                    <button type="button" class="option-btn" data-for="citta-spoleto">Spoleto</button>

                    <input type="radio" name="citta" value="perugia" id="citta-perugia" class="hidden-input">
                    <button type="button" class="option-btn" data-for="citta-perugia">Perugia</button>

                    <input type="radio" name="citta" value="todi" id="citta-todi" class="hidden-input">
                    <button type="button" class="option-btn" data-for="citta-todi">Todi</button>

                    <input type="radio" name="citta" value="assisi" id="citta-assisi" class="hidden-input">
                    <button type="button" class="option-btn" data-for="citta-assisi">Assisi</button>
                </div>
            </div>

            <div class="filtro-container">
                <h3>Scegli il tipo di ristorante</h3>
                <div class="filtro-opzioni" id="tipo-opzioni">
                    <input type="radio" name="filtro" value="1" id="tipo-1" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-1">Pizzerie</button>
                    
                    <input type="radio" name="filtro" value="2" id="tipo-2" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-2">Sushi</button>

                    <input type="radio" name="filtro" value="3" id="tipo-3" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-3">Rosticcerie</button>

                    <input type="radio" name="filtro" value="4" id="tipo-4" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-4">Fast Food</button>

                    <input type="radio" name="filtro" value="5" id="tipo-5" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-5">Pesce</button>

                    <input type="radio" name="filtro" value="6" id="tipo-6" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-6">Vegetariano</button>

                    <input type="radio" name="filtro" value="7" id="tipo-7" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-7">Vegano</button>

                    <input type="radio" name="filtro" value="8" id="tipo-8" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-8">Gelaterie</button>

                    <input type="radio" name="filtro" value="9" id="tipo-9" class="hidden-input">
                    <button type="button" class="option-btn" data-for="tipo-9">Streetfood</button>
                </div>
            </div>

            <div class="filtro-container">
                <h3>Allergie e intolleranze</h3>
                <div class="filtro-opzioni filtro-2" id="allergie-opzioni">
                    <input type="checkbox" name="allergie" value="1" id="allergia-1" class="hidden-input">
                    <button type="button" class="option-btn" data-for="allergia-1">Glutine</button>
                    
                    <input type="checkbox" name="allergie" value="2" id="allergia-2" class="hidden-input">
                    <button type="button" class="option-btn" data-for="allergia-2">Crostacei e derivati</button>

                    <input type="checkbox" name="allergie" value="3" id="allergia-3" class="hidden-input">
                    <button type="button" class="option-btn" data-for="allergia-3">Uova e derivati</button>
                    
                    <input type="checkbox" name="allergie" value="7" id="allergia-7" class="hidden-input">
                    <button type="button" class="option-btn" data-for="allergia-7">Latte e derivati</button>

                    <input type="checkbox" name="allergie" value="11" id="allergia-11" class="hidden-input">
                    <button type="button" class="option-btn" data-for="allergia-11">Semi di sesamo</button>

                    <input type="checkbox" name="allergie" value="15" id="allergia-15" class="hidden-input">
                    <button type="button" class="option-btn" data-for="allergia-15">Nichel</button>
                </div>
            </div>
        </div>

        <br />

        <div class="bottoni">
            <button id="cancellaFiltri" type="button" class="bottoni-2">Cancella filtri</button>
            <input type="submit" value="Cerca" class="bottoni-2">
        </div>
    </form>

    <div id="results"></div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
    // Configurazione BASE
    const API_BASE_URL = "http://localhost:3000/api";
    const form = document.getElementById("scelta");
    const resultsContainer = document.getElementById("results");
    const optionButtons = document.querySelectorAll('.option-btn');
    const clearButton = document.getElementById("cancellaFiltri");

    if (!form) return;

    // --- 1. Gestione Clic sui Bottoni Opzione (Nuova Interfaccia) ---

    // Funzione che gestisce il click sul bottone e seleziona l'input nascosto
    function handleOptionClick(e) {
        e.preventDefault(); 
        
        const targetInputId = this.getAttribute('data-for');
        const targetInput = document.getElementById(targetInputId);

        if (targetInput) {
            // Radio: seleziona l'input. Checkbox: inverte lo stato.
            if (targetInput.type === 'radio') {
                targetInput.checked = true;
            } else if (targetInput.type === 'checkbox') {
                targetInput.checked = !targetInput.checked;
            }
        }
    }

    // Collega il listener a tutti i bottoni di opzione
    optionButtons.forEach(button => {
        button.addEventListener('click', handleOptionClick);
    });

    // --- 2. Gestione Submit Form (Cerca) ---
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        resultsContainer.innerHTML = 'Caricamento dei ristoranti in corso...';
        resultsContainer.style.display = "block";

        const selections = collectSelections();

        // üü¢ Conversione necessaria per il backend
        const tipoRistoranteNum = selections.tipoRistorante ? Number(selections.tipoRistorante) : null;
        
        // Passaggio 1: Salva le preferenze (usando il valore stringa originale se necessario)
        // Se il tuo backend accetta il tipo come stringa nel POST, usa selections.tipoRistorante
        const saved = await savePreferences(selections.tipoRistorante, selections.allergie);
        if (!saved) return; 

        // Passaggio 2: Cerca e visualizza i ristoranti (usando il valore numerico)
        const restaurants = await fetchRestaurants(selections.citta, tipoRistoranteNum, selections.allergie);

        if (!restaurants || restaurants.length === 0) {
            resultsContainer.innerHTML = '<p style="color: red; font-weight: bold;">Nessun ristorante trovato con i filtri selezionati.</p>';
        } else {
            displayRestaurants(restaurants);
        }
    });

    // --- FUNZIONI HELPER ---

    // Raccoglie tutti i valori del form selezionati come STRINGHE
    function collectSelections() {
        const citta = document.querySelector('input[name="citta"]:checked')?.value;
        const tipoRistorante = document.querySelector('input[name="filtro"]:checked')?.value;
        const allergie = Array.from(
            document.querySelectorAll('input[name="allergie"]:checked')
        ).map(el => el.value);

        return { citta, tipoRistorante, allergie };
    }

    // Chiamata API per salvare le preferenze
    async function savePreferences(tipoRistorante, allergie) {
        try {
            // Qui usiamo la stringa, assumendo che il POST la gestisca
            const response = await fetch(`${API_BASE_URL}/preferences`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tipoRistorante, allergie })
            });
            
            if (!response.ok) throw new Error(`HTTP status: ${response.status}`);
            
            return true;
        } catch (err) {
            console.error("Errore salvataggio preferenze:", err);
            alert("Errore nel salvataggio delle preferenze.");
            resultsContainer.innerHTML = '';
            return false;
        }
    }

    // Chiamata API per cercare i ristoranti filtrati
    async function fetchRestaurants(citta, tipoRistoranteNum, allergie) {
        const queryParams = new URLSearchParams();
        
        // Aggiunge la citt√† e il TIPO (usando il NUMERO convertito) ai parametri
        if (citta) queryParams.append("citta", citta);
        if (tipoRistoranteNum) queryParams.append("tipo", tipoRistoranteNum);
        
        // Aggiunge tutte le allergie selezionate
        allergie.forEach(all => queryParams.append("allergie", all));
        
        try {
            const response = await fetch(`${API_BASE_URL}/restaurants?${queryParams.toString()}`);
            
            if (!response.ok) throw new Error(`HTTP status: ${response.status}`);
            
            return await response.json();
        } catch (err) {
            console.error("Errore fetch ristoranti:", err);
            alert("Errore durante la ricerca dei ristoranti.");
            resultsContainer.innerHTML = '';
            return null;
        }
    }

    // Visualizza i risultati
    function displayRestaurants(restaurants) {
        resultsContainer.innerHTML = "";
        resultsContainer.style.display = "grid";

        restaurants.forEach(r => {
            const card = document.createElement("div");
            card.className = "restaurant-card";

            const filtriText = r.Filtri && r.Filtri.length ? r.Filtri.join(", ") : "Nessuno";

            card.innerHTML = `
                <h4>${r.Nome}</h4>
                <p><strong>Indirizzo:</strong> ${r.Indirizzo || 'N/A'}</p>
                <p><strong>Tipo:</strong> ${r.Tipo || 'N/A'}</p>
                <p><strong>Citt√†:</strong> ${r.Citta || 'N/A'}</p>
                <p><strong>Filtri: </strong> ${filtriText}</p>
                <button class="fav-btn" data-nome="${r.Nome}">‚≠ê Aggiungi ai preferiti</button>
            `;

            resultsContainer.appendChild(card);
        });
    }

    // --- 3. Gestione Cancella Filtri ---
    clearButton.addEventListener("click", () => {
        // Usa form.reset() per pulire tutti gli input (radio e checkbox)
        form.reset();
        resultsContainer.innerHTML = "";
        resultsContainer.style.display = "none";
        alert("Filtri cancellati!");
    });
});
    </script>
</body>
</html>